generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String        @id @default(cuid())
  email           String        @unique
  password        String
  name            String?
  role            Role
  isActive        Boolean       @default(true)
  emailVerified   Boolean       @default(false)
  profileImageUrl String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  lastLogin      DateTime?
  organizationId  String?
  departmentId    String?
  admin           Admin?
  student         Student?
  department      Department?   @relation(fields: [departmentId], references: [id])
  organization    Organization? @relation(fields: [organizationId], references: [id])

  @@map("users")
}

model Organization {
  id               String       @id @default(cuid())
  name             String
  address          String?
  email            String?
  phone            String?
  isActive         Boolean      @default(true)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  domain           Boolean      @default(true)
  logoUrl          Boolean      @default(true)
  slug             Boolean      @default(true)
  subscriptionPlan Boolean      @default(true)
  departments      Department[]
  users            User[]

  @@map("organizations")
}

model Department {
  id             String       @id @default(cuid())
  name           String
  description    String?
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  complaints     Complaint[]
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  users          User[]

  @@map("departments")
}

model Admin {
  id                String          @id @default(cuid())
  userId            String          @unique
  fullName          String
  email             String          @unique
  username          String          @unique
  passwordHash      String
  phone             String?
  avatarUrl         String?
  department        String?
  role              Role            @default(ADMIN)
  dateJoined        DateTime        @default(now())
  lastLogin         DateTime?
  isActive          Boolean         @default(true)
  activityLogs      ActivityLog[]
  analytics         AdminAnalytics?
  user              User            @relation(fields: [userId], references: [id])
  categories        Category[]
  messagesReceived  ChatMessage[]   @relation("AdminReceivedMessages")
  messagesSent      ChatMessage[]   @relation("AdminSentMessages")
  complaintsHandled Complaint[]
  notifications     Notification[]

  @@map("admins")
}

model Student {
  id                 String         @id @default(cuid())
  userId             String         @unique
  matricNo           String         @unique
  fullName           String
  email              String         @unique
  phone              String?
  department         String
  level              String
  hostel             String?
  avatarUrl          String?
  status             String         @default("Active")
  joinedDate         DateTime       @default(now())
  passwordHash       String
  lastLogin          DateTime?
  totalComplaints    Int            @default(0)
  resolvedComplaints Int            @default(0)
  activityLogs       ActivityLog[]
  messagesReceived   ChatMessage[]  @relation("StudentReceivedMessages")
  messagesSent       ChatMessage[]  @relation("StudentSentMessages")
  complaints         Complaint[]
  notifications      Notification[]
  user               User           @relation(fields: [userId], references: [id])

  @@map("students")
}

model Complaint {
  id             String          @id @default(cuid())
  title          String
  description    String
  status         ComplaintStatus @default(PENDING)
  resolutionNote String?
  feedback       String?
  dateSubmitted  DateTime        @default(now())
  dateResolved   DateTime?
  studentId      String
  adminId        String?
  departmentId   String?
  categoryId     String?
  chatMessages   ChatMessage[]
  assignedAdmin  Admin?          @relation(fields: [adminId], references: [id])
  category       Category?       @relation(fields: [categoryId], references: [id])
  department     Department?     @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  student        Student         @relation(fields: [studentId], references: [id])

  @@map("complaints")
}

model ChatMessage {
  id                String        @id @default(cuid())
  message           String
  attachments       String[]      @default([])
  timestamp         DateTime      @default(now())
  status            MessageStatus @default(SENT)
  senderAdminId     String?
  receiverAdminId   String?
  senderStudentId   String?
  receiverStudentId String?
  complaintId       String?
  fileUrl           String?
  fileName          String?
  complaint         Complaint?    @relation(fields: [complaintId], references: [id])
  receiverAdmin     Admin?        @relation("AdminReceivedMessages", fields: [receiverAdminId], references: [id])
  receiverStudent   Student?      @relation("StudentReceivedMessages", fields: [receiverStudentId], references: [id])
  senderAdmin       Admin?        @relation("AdminSentMessages", fields: [senderAdminId], references: [id])
  senderStudent     Student?      @relation("StudentSentMessages", fields: [senderStudentId], references: [id])

  @@map("chat_messages")
}

model Notification {
  id        String           @id @default(cuid())
  title     String
  message   String
  type      NotificationType @default(INFO)
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  adminId   String?
  studentId String?
  admin     Admin?           @relation(fields: [adminId], references: [id])
  student   Student?         @relation(fields: [studentId], references: [id])

  @@map("notifications")
}

model ActivityLog {
  id        String   @id @default(cuid())
  action    String
  timestamp DateTime @default(now())
  ipAddress String?
  adminId   String?
  studentId String?
  admin     Admin?   @relation(fields: [adminId], references: [id])
  student   Student? @relation(fields: [studentId], references: [id])

  @@map("activity_logs")
}

model AdminAnalytics {
  id                 String   @id @default(cuid())
  totalStudents      Int      @default(0)
  totalComplaints    Int      @default(0)
  resolvedComplaints Int      @default(0)
  pendingComplaints  Int      @default(0)
  activeStudents     Int      @default(0)
  suspendedStudents  Int      @default(0)
  avgResolutionTime  Float?
  lastUpdated        DateTime @default(now())
  adminId            String   @unique
  admin              Admin    @relation(fields: [adminId], references: [id])

  @@map("admin_analytics")
}

model Category {
  id          String      @id @default(cuid())
  name        String      @unique
  description String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  adminId     String?
  admin       Admin?      @relation(fields: [adminId], references: [id])
  complaints  Complaint[]

  @@map("categories")
}

enum Role {
  ADMIN
  SUPER_ADMIN
  STUDENT
}

enum ComplaintStatus {
  PENDING
  IN_PROGRESS
  RESOLVED
  REJECTED
}

enum MessageStatus {
  SENT
  RECEIVED
  READ
}

enum NotificationType {
  INFO
  WARNING
  SUCCESS
}
